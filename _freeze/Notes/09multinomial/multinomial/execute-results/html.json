{
  "hash": "67abecc95740f095b8f385029eacd6f9",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Multinomial Models\"\nauthor: \"Michael Fehl\"\ndescription: \"Conditional Logit & Multinomial Logit Models\"\nimage: /images/Gumbel-Density.png\ndate: 26-01-2026\nclass-notes: true\nformat:\n  html:\n    embed-resources: true\n---\n\n# Theory\n\n## Specification: $P_{ij}^{y_{ij}}$\n\nA natural question that arises regarding our log-likelihood models for discrete outcomes is that of **model specification**. Specifically, how do we select a form for $F_j (x_{i},\\beta)$?\n\nSuppose we have $j=1,2,...,m$ alternatives. We can then define the following:\n\n$$U_j = V_j + \\varepsilon_j \\tag{1}$$\n\nWhere:\n  \n  * $U_j$ : represents the <u>utility</u> of choosing alternative $j$\n  * $V_j$ : the <u>deterministic component</u> (comprised of all the possible regressors) for alternative $j$\n  * $\\varepsilon_j$ : <u>random error term</u> -- included since all individuals have the alternatives but possibly different utilities for a choice -- allows for some randomness\n  \nWhen does an individual prefer alternative $j$ to alternative $k$? Simply when they get more utility from $j$ than they do $k$. More formally:\n\n$$\n\\begin{aligned}\n\\mathbb{P}[y_i = j \\mid X_i] &= \\mathbb{P}[U_j \\ge U_k, \\forall_{j \\neq k}] \\\\\n&= \\mathbb{P}[U_k - U_j \\leq 0, \\forall_{j \\neq k}] \\\\ \n&= \\mathbb{P}[\\varepsilon_k - \\varepsilon_j \\leq V_k - V_j, \\forall_{j \\neq k}] \\\\\n&= \\mathbb{P}[\\widetilde{\\varepsilon}_{kj} \\leq -\\widetilde{V}_{kj} , \\forall_{j \\neq k}]\n\\end{aligned} \\tag{2}\n$$\n\nNote that in the last step we simply rewrite the difference between alternative $k$ and alternative $j$ as $\\tilde{\\varepsilon}_{kj}$.\n\nLets explore this in a 3-choice model:\n\n$$\n\\begin{aligned}\n\\mathbb{P}[y_i=1 \\mid X_i] = \\mathbb{P}[\\widetilde{\\varepsilon}_{31} \\leq -\\widetilde{V}_{31}, \\widetilde{\\varepsilon}_{21} \\leq -\\widetilde{V}_{21} \\mid X_i]\n\\end{aligned} \\tag{3}\n$$\n\nThis is telling us the same thing as (2): the probability that individual $i$ chooses alternative $1$ (given a set of alternatives) is equal to the probability that individual $i$ prefers alternative $1$ to both alternative $3$ as well as alternative $2$. \n\nWe can write this as a joint probability density function of the error terms:\n\n$$\n\\begin{aligned}\n= \\int_{-\\infty}^{-\\tilde{V}_{31}} \\int_{-\\infty}^{-\\tilde{V}_{21}} f\\left(\\tilde{\\varepsilon}_{31}, \\tilde{\\varepsilon}_{21} \\right) d \\tilde{\\varepsilon}_{21} d \\tilde{\\varepsilon}_{31}\n\\end{aligned} \\tag{4}\n$$\n\nAlthough this is the correct theoretical specification, an issue arises when we try to compute this for more alternatives. Imagine we have a set of 20 alternatives; we would have a 19-degree integration which would be computationally impossible to evaluate in any finite time period. Thus, we need to simplify this integration somehow.\n\n## Distribution Assumption of the Errors\n\nTo simplify the model, a key assumption we need to make is on the distribution of the error terms; specifically we need to assume that the errors follow a **Type 1 Extreme Value Distribution** (Gumbel Distribution):\n\n$$f\\left(\\varepsilon_j \\right) \\sim Gumbel\\left( \\mu, \\beta \\right)$$\n\nWhich indirectly makes assumptions on the differenced errors (from our 3-alternative example above):\n\n$$f\\left(\\tilde{\\varepsilon}_{21} ,  \\tilde{\\varepsilon}_{31} \\right) \\sim Gumbel\\left( \\mu, \\beta \\right)$$\n\nWhere the Gumbel Distribution's PDF has the following form:\n\n$$ f(\\varepsilon_j) = e^{-\\varepsilon_j} \\cdot e^{-e^{-\\varepsilon_j}} \\tag{5}$$\n\n![**Figure 1**: PDF of a Gumbel Distributed Random Variable](../../images/Gumbel-Density.png)\n\n** *Note*: multinomial probit assumes a <u>normal</u> (Gaussian) distributional form of the error terms; we will not cover that case here.\n\nFurther, we also assume these errors are IID: importantly, this assumption is placed upon the <u>alternatives</u>, rather than the individuals (although that is always assumed in the background). This means that our error terms are uncorrelated across alternatives ($j = 1, 2, ... , m$); every alternative is drawn at random with equal probability.\n\n*Note*:\n\nThis is a strong assumption that will be relaxed later on. For now, imagine the case where our set of alternatives consists of different cities an individual could to move to, say:\n\n$$\\{\\text{Alternatives}\\}_m = \\{\\text{Barcelona, Madrid, Beijing, Moscow}\\}. $$\n\nIntuitively, an individual's utility for Barcelona and Madrid are likely highly correlated as they share similar characteristics (location, weather, language, etc), compared to other cities in our set, such as Beijing or Moscow. The IID assumption ignores this correlation, treating a preference for Barcelona as completely independent of a preference for Madrid.\n\n\nThe reason we choose the Gumbel distribution for our errors is that, after substituting the Gumbel PDF from (5) into our joint PDF function from (4), our conditional probability function simplifies to:\n\n$$ \\mathbb{P}[y_i = j \\mid X_i] = \\frac{e^{V_j}}{e^{V_1} + e^{V_2} + ... + e^{V_m}} \\tag{6}$$\n\nThis result is much more computationally friendly, even when as th choice set increases to 20 or 30 alternatives, the Gumbel distribution allows for a closed-form solution (6). \n\nFurther, although the Gumbel distribution is asymmetrical, it is the standard choice here because it is an <u>Extreme Value distribution</u>. It is designed to model the maximum of a series of random variables, making it ideal for our utility framework where we assume the individual selects the alternative that yields the **maximum utility**.\n\nIn the real world, this distributional form is useful in predicting the chance that an extreme event will occur (earthquake prediction simulations, measuring financial losses, insurance risks, etc).\n\n## Specification: $V_j$\n\nWhat remains is a specification of the deterministic component of the utility function. There exists two main specification methods (and a mixture between them):\n\n$$\nV_j = \\begin{cases}\n  X_{ij}'\\beta &\\text{\"Conditional Logit\"} \\\\\n   \\\\\n  X_i'\\beta_j &\\text{\"Multinomial Logit\"} \\\\\n   \\\\\n  X_{ij}'\\beta + \\omega_i'\\alpha_j &\\text{\"Mixed Logit\"}\n\\end{cases} \\tag{7}\n$$\n\n### 1. Conditional Logit\n\nWe specify the deterministic component of utility of alternative $j$ with *alternative-varying regressors*, i.e. \n\n$$V_j = X_{ij}'\\beta \\tag{8}$$\n\nThese regressors can vary across **individuals** and **alternatives**. Using our previous choice set of cities, we can think of these regressors as being characteristics of the cities themselves impacting the overall utility: weather, location, population, etc; varying across individuals.\n\nThese are the characteristics the regressors share but can vary in their utility for each individual. I.e. I might value the warm weather of Barcelona more than the cold of Moscow, but some other individual might value the inverse case.\n\nPlugging in this specification for $V_j$ into equation (1), we get the following form for the likelihood function:\n\n$$P_{ij} = \\mathbb{P}[y_i = j \\mid X_i] = \\frac{e^{x_{ij}'\\beta}}{\\displaystyle\\sum_{k=1}^me^{x_{ik}'\\beta}} \\tag{9}$$\n\n### 2. Multinomial Logit\n\nIn this case, the specified regressors contained in the deterministic component of utility are individual-specific, but **not** alternative-specific. We define these as *alternative-invariant regressors*: \n\n$$V_j = X_i'\\beta_j \\tag{10}$$\n\nUsing our same cities choice set, we can think of this being individual-level characteristics affecting the utility assigned to a specific city; my current lifestyle/age will impact the utility I receive moving to a city like Barcelona versus a city like Moscow; however, characteristics of the city itself (its party scene, age of population, etc) has no effect on my utility assigned to moving to that city. \n(*personal note: I find this hard to believe; I would expect that the utility you get from aspects like your age are tied in directly to the characteristics of the cities themselves. maybe another example would make this specifiation choice more clear, but it seems unrealistic for our correct model specification to be mlogit.*)\n\nPlugging in this specification for $V_j$ into equation (1), we get the following form for the likelihood function:\n\n$$P_{ij} = \\mathbb{P}[y_i = j \\mid X_i] = \\frac{e^{x_i'\\beta_j}}{\\displaystyle\\sum_{k=1}^m e^{x_i'\\beta_k}} \\tag{11}$$\n\n## Marginal Effects\n\nLet's look at another example. Suppose that we are fishing in Barcelona, and we have the following set of alternatives for fishing locations:\n\n$$\\{\\text{Fishing Choice Alternatives}\\}_{m=4} = \\{\\text{Beach}_1, \\text{Pier}_2, \\text{Private Boat}_3, \\text{Charter Boat}_4\\}$$\n\n### Conditional Logit\n\n$$U_{ij} = X_{ij}'\\beta + \\varepsilon_{ij} \\tag{12}$$\n\nSuppose we define the vector of regressors in $X_{ij}$ as the following:\n\n$$\nX_{ij} = \\begin{bmatrix}\n  \\text{Catch Rate} \\\\\n  \\text{Price}\n\\end{bmatrix}\n$$\n\n\nNote that these regressors are *alternative-variant*: \n\n  * **Catch Rate** depends on the choice of beach, boat, pier, etc; \n  * same goes for the **Price** of fishing at a given location.\n\n#### Same-Alternative ME\n\nThe marginal change in the probability of fishing at the beach is the marginal effect given by beta; in other words, how the probability of individual $i$ choosing a specific location (e.g., $\\Delta P_{i,\\text{beach}}$) changes when a characteristic of that same location (e.g., $\\Delta \\text{Catch Rate}_{i, \\text{Beach}}$) changes.\n\n$$\n\\begin{align}\n\\frac{\\partial P_{i1}}{\\partial X_{i1}} \n&= \\frac{\\partial \\mathbb{P}[y_i = \\text{Beach} \\mid \\{\\text{Catch Rate, Price} \\}_i]}{\\partial X_{i, \\text{Beach}}} \\\\\n&= \\left( \\underbrace{\\frac{e^{x_{i1}'\\beta}}{\\sum_{k=1}^m e^{x_{ik}'\\beta}}}_{P_{i1}} - \\underbrace{\\left( \\frac{e^{x_{i1}'\\beta}}{\\sum_{k=1}^m e^{x_{ik}'\\beta}} \\right)^2}_{(P_{i1})^2} \\right) \\beta \\\\\n&= P_{i1}(1-P_{i1})\\beta \\tag{14}\n\\end{align}\n$$\n\nWhat does this tell us?\n\n  * Beta tells us the sign of the marginal effect: since $P_{ij} \\in [0, 1]$, it must be that if beta is positive, so too is the marginal effect.\n  * The marginal effect coffecient value is not directly interpretable -- we cannot separate $P_{ij}$ and $1 - P_{ij}$ here.\n  \n#### Cross-Alternative ME\n\nWhat if we look across alternatives? I.e., how does a change in the characteristics of the Beach ($\\Delta X_{i,\\text{Beach}}$) affect the probability of individual $i$ choosing to fish from the Pier ($\\Delta P_{i, \\text{Pier}}$)?\n\nEquivalently, this is expressed as:\n\n$$\n\\begin{align}\n\\frac\n{\\partial \\mathbb{P}[y_i = Pier \\mid \\{\\text{Catch Rate, Price} \\}_i]}\n{\\partial X_{i, Beach}} \n&= \n\\frac\n{\\partial P_{i2}}\n{\\partial X_{i1}} \\\\\n&= \n\\frac\n{0 - e^{x_{i2}'\\beta}e^{x_{i1}'\\beta} \\beta}\n{\\left(\\sum_{k=1}^me^{x_{ik}'\\beta}\\right)^2} \\\\\n&= \n(-P_{i2})P_{i1}\\beta \\tag{15}\n\\end{align}\n$$\n\nObservations:\n\n  * Beta and the Marginal Effect have opposing signs: if $\\beta \\gt 0$, then $ME(\\beta) \\lt 0$\n  * Again, cannot interpret the magnitude of beta.\n  \n\n\nIn summary: we can write the two types of marginal effects as the following for a conditional logit model:\n\n\n$$\n\\frac{\\partial P_{ij}}{\\partial X_{ik}} = \n\\begin{cases}\n  P_{ij}(1-P_{ij}) & j = k \\\\\n  P_{ij}(-P_{ik}) & j \\neq k\n\\end{cases} \\tag{16}\n$$\n\nNote that the direction is <u>unambiguous</u> for both cases.\n\n### Multinomial Logit\n\nWhat happens when applied to a multinomial logit model? Is the marginal effect the same?\n\nThe marginal effect is written as:\n\n$$\\frac{\\partial P_{ij}}{\\partial X_i} = P_{ij}(\\beta_j - \\bar{\\beta}_i), \\\\ \\text{where } \\bar{\\beta}_i \\equiv \\sum_{k=1}^m P_{ik}\\beta_k \\tag{17}$$\n\nWhere $\\bar{\\beta}_i$ is a \"weighted average\" of $\\beta$'s (coefficients), weighted by the probability of choosing a particular alternative $k$.\n\nThe issue here is that finding the sign of $\\beta_j$ is not informative of the ME -- it depends on the value of $\\bar{\\beta}_i$; i.e., the direction is <u>ambiguous</u>. \n\n### Relative Risk Interpretation\n\nAnother way to interpret our coefficients is looking at the relative risk ratio (rrr), by taking the ratio of the probabilities of two distinct alternatives\n\n#### Conditional Logit\n\n\n$$\n\\begin{align}\n\\frac\n{P_{ij}}\n{P_{ik}} &=\n\\frac\n{\\mathbb{P}[y_i = j \\mid X_i]}\n{\\mathbb{P}[y_i = k \\mid X_i]} \\\\\n&= \n\\frac\n{e^{x_{ij}'\\beta}}\n{e^{x_{ik}'\\beta}} && \\text{by conditional logit def} \\\\\n&= \ne^{(x_{ij}-x_{ik})'\\beta} && \\text{property of exponents} \\\\\nlog\n\\frac\n{P_{ij}}\n{P_{ik}} &= \n(X_{ij}-X_{ik})'\\beta && \\text{log both sides} \\tag{18}\n\\end{align}\n$$\n\n\nThus, we can interpret $\\beta$ as the change in the log-odds of choosing alternative $j$ over alternative $k$ for every one-unit increase in the difference between their characteristics ($X_{ij}$-$X_{ik}$)\n\nIn our fishing example, suppose we get output of $\\beta_{price} = -0.05$ for \n($X_{i,Beach} - X_{i,Pier}$) -- we would interpret this as: for a $1 increase in the price of the Beach (relative to the Pier), the odds of choosing the Beach over the Pier drop by 5%.\n\n\n#### Multinomial Logit\n\nFor mlogit, its important to standardize a beta, essentially to set one alternative as our \"base case\" with which we can relatively compare the other alternatives. For example, suppose we set $\\beta_k = \\beta_1 = 0$; then, our relative risk ratio (also know as odds-ratio) is derived as the following:\n\n\n$$\n\\begin{align}\n\\frac\n{P_{ij}}\n{P_{ik}} &=\n\\frac\n{\\mathbb{P}[y_i = j \\mid X_i]}\n{\\mathbb{P}[y_i = k \\mid X_i]} \\\\\n&= \n\\frac\n{e^{x_i'\\beta_j}}\n{e^{x_i'\\beta_k}} && \\text{by conditional logit def} \\\\\n&= \ne^{x_i'(\\beta_j-\\beta_k)} && \\text{property of exponents} \\\\\n&= \n\\frac\n{\\mathbb{P}[y_i = j \\mid X_i]}\n{\\mathbb{P}[y_i = 1 \\mid X_i]} && \\text{plug in } \\beta_k  = \\beta_1 \\\\\n&= \ne^{x_i'\\beta_j}\n&& \\text{normalize: } \\beta_1 = 0\\\\\nlog\n\\frac\n{P_{ij}}\n{P_{i1}} &= \n(X_i)'\\beta_j && \\text{log both sides} \\tag{19}\n\\end{align}\n$$\n\nHere we can interpret $\\beta$ as the change in the log-odds of choosing alternative $j$ relative to the base case (alternative $k$) for a one-unit increase in *individual-specific regressors* (e.g., Income). Note that unlike the clogit model, where we look at the difference in characteristics between choices, here the characteristic is fixed for the individual, and the coefficient $\\beta_j$ represents how that trait shifts the individual's preference toward alternative $j$ specifically.\n\n\n## Shortcomings\n\nA seemingly powerful aspect of these models is the fact that the probabilities only depend the two specific alternatives we are comparing at a given time, stemming from out IID assumption early on. However, we can see an example as to why this might fail in reality.\n\nSuppose we want to model traffic in a city, and there exists only two forms of transportation, a <span style=\"color:green\">car</span> and a <span style=\"color:red\">red bus</span>, s.t.:\n\n$$\\frac{\\mathbb{P}[\\text{car}]}{\\mathbb{P}[\\text{red bus}]} = \\frac{0.5}{0.5}$$\n\n  * *Note that this is consistent since* $\\displaystyle\\sum_{i=1}^N\\mathbb{P}_i = 1$\n\nNow imagine we introduce a new form of transportation (i.e. a third alternative) in the city: a <span style=\"color:blue\">blue bus</span>. Intuitively, we expect to see:\n\n$$\n\\begin{align}\n\\mathbb{P}[\\text{blue bus}] = \\mathbb{P}[\\text{red bus}] = 25\\% \\\\\n\\mathbb{P}[\\text{car}] = 50\\%\n\\end{align}\n$$\n\nYet for our multinomal models, we instead derive from the IID (random sampling) assumption that our new choice distribution is:\n\n\n$$\\mathbb{P}[\\text{blue bus}] = \\mathbb{P}[\\text{red bus}] = \\mathbb{P}[\\text{car}] = 33.33\\%$$\nAnother way to say the same thing is that an improved product gains share from all other products in proportion to their original shares; and when a product loses share, it loses to others in proportion to their shares.\n\nAs it stands, our current models cannot account for this phenomena; hence, we need to relax our IID assumption and try to construct a different variant of our models: **Nested Logit**.\n\n\n\n# Applied\n\n```{stata multinomal logit}\n# mutlinomial logit regression\nmlogit depvar [indepvars]\n```\n\n```{stata conditional logit}\n# normal conditional logit regression\nclogit depvar [indepvars], group(varname)\n\n# facilitates the data preparation and also allows estimation of a mixed logit model\nasclogit depvar [indepvars], case(varname) alternatives(varname)\n```\n\n",
    "supporting": [
      "multinomial_files"
    ],
    "filters": [],
    "includes": {}
  }
}